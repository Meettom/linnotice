# Linux服务监控及自动触发邮件通知

## 使用方法
将 linnotice.sh 下载之后放到你的服务器的 /root/ 路径里面，执行路径为 /root/linnotice.sh

然后在宝塔面板或者Cron里面添加执行指令，类似：sh /root/linnotice.sh ，或者完整的 sudo -u root bash -c '/root/linnotice.sh' ，设置好定时执行即可。

注意linnotice.sh里面的下面的内容需要替换成你自己的：
1. API_KEY="50ad6789000000000000000021e177c"      #替换成自己的AokSend的api_key
2. TEMPLATE_ID="E_1000000000057"       #替换成自己的AokSend的邮件模板id
3. TO_EMAIL="meetxxxxxx@163.com"       #替换成自己需要接收通知的邮箱


## 一、代码功能概述

该脚本用于监控 Linux 系统中特定端口（3306，MySQL 数据库，端口可以任意指定）的服务运行状态。当检测到端口无服务监听时，会自动执行以下操作：
1. 尝试重启相关服务（amavisd）
2. 通过 AokSend API 发送邮件通知管理员
3. 记录异常日志

该脚本的常用场景：
1. 监控Mysql是否停止，监控3306端口，若Mysql异常停止，可以自动触发邮件给指定的邮箱告警。

## 二、使用说明

### 1. 脚本参数说明

| 变量/参数         | 说明                                                                 |
|-------------------|----------------------------------------------------------------------|
| `10024`           | 监控的目标端口号（可修改为其他需要监控的端口）                       |
| `amavisd`         | 需要监控的服务名称（需与 `systemctl` 管理的服务名一致）              |
| `API_URL`         | AokSend 邮件发送 API 地址                                            |
| `API_KEY`         | AokSend 账户的 API 密钥                                              |
| `TEMPLATE_ID`     | AokSend 的邮件模板 ID                                                |
| `TO_EMAIL`        | 接收通知邮件的目标邮箱地址                                           |
| `NOTIFICATION`    | 通知邮件的内容模板                                                   |

### 2. 注意事项

1. **服务依赖**：
   - 确保 `systemctl` 和 `netstat`/`ss` 命令可用
   - 脚本需要 root 权限才能检查系统端口和服务

2. **邮件发送可靠性**：
   - 建议添加重试机制（如 curl 失败后重试 3 次）
   - 考虑添加邮件发送失败的日志记录

### 3. 端口与服务的关系

在 Linux 系统中，端口和服务是紧密关联的：
- **服务启动时**：服务进程会绑定到特定端口并开始监听
- **服务停止时**：操作系统会释放该端口，端口状态变为未使用
- **端口检查原理**：`netstat`/`ss` 命令通过查询内核的 TCP/IP 协议栈获取端口状态信息

### 4. 服务异常停止导致端口无监听的原因

1. **进程崩溃**：服务异常终止后，操作系统会立即释放端口
2. **资源耗尽**：如内存不足导致进程被 OOM Killer 终止
3. **配置错误**：服务启动失败（如端口被其他进程占用）
4. **系统重启**：未设置服务开机自启

### 5. 常见端口及对应服务

| 端口号 | 典型服务                |
|--------|-------------------------|
| 22     | SSH 远程连接            |
| 25     | SMTP 邮件发送            |
| 80     | HTTP Web 服务            |
| 443    | HTTPS 安全 Web 服务      |
| 3306   | MySQL 数据库            |
| 5432   | PostgreSQL 数据库       |

## 三、部署与使用教程

### 方法 1：通过宝塔面板添加定时任务

1. 登录宝塔面板
2. 进入 **计划任务** 页面
3. 添加 **Shell 脚本** 任务：
   - 任务类型：Shell 脚本
   - 任务名称：`监控 10024 端口服务`
   - 执行周期：根据需求选择（如每 5 分钟）
   - 脚本内容：sudo -u root bash -c '/root/linnotice.sh'  //此处文件及位置改成自己的
4. 保存任务

### 方法 2：通过 crontab 添加定时任务

1. 编辑 root 用户的 crontab：
   ```bash
   sudo crontab -e
   ```

2. 添加以下内容（示例为每 5 分钟检查一次）：
   ```bash
   */5 * * * * /bin/bash /root/linnotice.sh
   ```

3. 保存并退出（在 vim 中按 `Esc`，输入 `:wq` 回车）

### 3. 验证脚本运行

1. 手动执行脚本测试：
   ```bash
   sudo /bin/bash /root/linnotice.sh
   ```

2. 检查以下内容：
   - 查看日志文件：`tail -f /var/log/linnotice_monitor.log`
   - 检查邮箱是否收到测试通知
   - 确认 cron 日志（`grep CRON /var/log/syslog`）

## 四、扩展建议

1. **多端口监控**：可修改脚本支持监控多个端口
   ```bash
   PORTS="10024 3306 22"
   for port in $PORTS; do
     if ! netstat -tulnp | grep ":$port" > /dev/null; then
       # 处理逻辑
     fi
   done
   ```

2. **服务健康检查**：添加更全面的服务状态检查（如进程存活、响应测试等）

3. **告警升级**：实现分级告警（如首次失败只记录，连续失败 3 次才发送邮件）

4. **性能优化**：对于高频检查，可考虑使用更高效的端口检查工具如 `ss` 替代 `netstat`

通过以上部署和使用方法，您可以有效监控关键服务的运行状态，并在服务异常时及时获得通知，确保系统稳定性。
